<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UPC & Code128 Scanner Overlay</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    text-align: center;
    background: #111;
    color: white;
  }
  #qr-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: auto;
  }
  #qr-video {
    width: 100%;
  }
  #result-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 200, 0, 0.8);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 18px;
    display: none;
    z-index: 1000;
    pointer-events: none;
  }
</style>
</head>
<body>
<h2>UPC & Code128 Scanner v2</h2>
<div id="qr-container">
  <div id="result-overlay"></div>
  <div id="qr-video"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const overlay = document.getElementById("result-overlay");
let overlayTimeout = null;

function showOverlay(message) {
  overlay.innerText = message;
  overlay.style.display = "block";

  // Clear any previous timeout
  if (overlayTimeout) {
    clearTimeout(overlayTimeout);
  }

  // Keep it visible until timeout
  overlayTimeout = setTimeout(() => {
    overlay.style.display = "none";
    overlayTimeout = null;
  }, 1000);
}

function onScanSuccess(decodedText, decodedResult) {
  console.log(decodedText, decodedResult);
  showOverlay(`✅ ${decodedText}`);
}

function onScanFailure(error) {
  // do nothing, don’t hide overlay here
}

function calculateQrbox(viewfinderWidth, viewfinderHeight) {
  const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
  return { width: Math.floor(minEdge * 0.9), height: Math.floor(minEdge * 0.3) };
}

const formatsToSupport = [
  Html5QrcodeSupportedFormats.UPC_A,
  Html5QrcodeSupportedFormats.CODE_128,
];
	
const html5QrCode = new Html5Qrcode("qr-video", { formatsToSupport: formatsToSupport });

const videoConstraints = {
  width: 720,
  height: 480,
  frameRate: 15,
  focusMode: "continuous",
  facingMode: "environment",
};

const config = { 
  fps: 8,
  videoConstraints: videoConstraints,
  qrbox: calculateQrbox,
  disableFlip: false,
  aspectRatio: 1,
  showTorchButtonIfSupported: true,
  focusMode: "continuous",
  advanced: [{ zoom: 1.0 }],
  rememberLastUsedCamera: false,
  useBarCodeDetectorIfSupported: true,
  experimentalFeatures: {
    useBarCodeDetectorIfSupported: true,
  },
  willReadFrequently: true,
};	

Html5Qrcode.getCameras().then(cameras => {
  if(cameras && cameras.length) {
    const cameraId = cameras.find(cam => cam.label.toLowerCase().includes("back"))?.id || cameras[0].id;
    html5QrCode.start(
      { deviceId: { exact: cameraId } },
      config,
      onScanSuccess,
      onScanFailure
    );
  }
}).catch(err => console.error(err));

let theInterval = setInterval(function () {
  if (Html5Qrcode.getState() === Html5QrcodeScannerState.SCANNING) {
    console.log("Applying video constraints");
    Html5Qrcode.applyVideoConstraints(videoConstraints);
    clearInterval(theInterval);
  }
}, 1000);
</script>
</body>
</html>
